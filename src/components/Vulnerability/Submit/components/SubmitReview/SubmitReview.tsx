import { useContext, useEffect, useState } from "react";
import { useTranslation } from "react-i18next";
import { AccordionContext } from "../../../VulnerabilityAccordion";
import Loading from "../../../../Shared/Loading";
import { onChainTransactionSuccess } from "../../Submit";
import EditIcon from "../../../../../assets/icons/edit.svg";
import { Card, IVulnerabilityData } from "../../../types";
import "./index.scss";
import { useEthers } from "@usedapp/core";
import { useClaim } from "hooks/contractHooks";
import { usePrevious } from "hooks/usePrevious";
import { useVaults } from "hooks/useVaults";
import { useSupportedNetwork } from "hooks/useSupportedNetwork";
import { readKey, encrypt, createMessage } from "openpgp";

interface IProps {
  cards: IVulnerabilityData
  setBotStatus: Function
}

export default function SubmitReview({ cards, setBotStatus }: IProps) {
  const isSupportedNetwork = useSupportedNetwork();
  const { chainId } = useEthers();
  const { t } = useTranslation();
  const { submitCard, toggleCard } = useContext(AccordionContext);
  const isVerified = cards.project.verified && cards.contact.verified && cards.description.verified && cards.terms.verified;
  const { vaults } = useVaults();
  const vault = vaults?.find(vault => vault.id === cards.project.projectId)!;
  const description = vault && vault.description;
  const committeeCheckedIn = vault && vault.committeeCheckedIn;
  const { account } = useEthers()
  const { send: submit, state: submitState } = useClaim(vault?.master.address)
  const [encryptedData, setEncryptedData] = useState<string | undefined>();
  const IpfsHash = require('ipfs-only-hash');

  const submittingVulnerability = submitState.status === 'Mining'
  const showSubmitWarning = !isVerified || !account;
  const prevSubmitState = usePrevious(submitState);

  const handleSubmit = async () => {
    const encryptedData = await pgpData();
    setEncryptedData(encryptedData);
    const cid = await IpfsHash.of(encryptedData.replace(/\s+/g, ''));
    submit(cid);
  }

  useEffect(() => {
    if (submitState.status !== prevSubmitState?.status && submitState.status === 'Success' && chainId) {
      const route = vault!.description?.["project-metadata"]?.name;
      const telegramBotUrl = `${description?.["communication-channel"]?.["committee-bot"]}`;
      onChainTransactionSuccess(submitCard, telegramBotUrl, encryptedData!, submitState.receipt?.transactionHash!, route, setBotStatus, chainId, cards.project.contractAddress);
    }
  }, [encryptedData, submitState, setBotStatus, vault, description, submitCard, chainId, prevSubmitState?.status, cards.project.contractAddress])

  const pgpData = async () => {
    const dataToEncrypt = `
    Project Name: ${cards.project.projectName}
    Title: ${cards.description.title}
    Description: ${cards.description.description}
    Telegram username: ${cards.contact.username}
    Beneficiary: ${cards.contact.beneficiary}
    `
    const publicKeyOrKeysArmored = description?.["communication-channel"]?.["pgp-pk"];
    let publicKeyOrKeys
    if (Array.isArray(publicKeyOrKeysArmored)) {
      publicKeyOrKeys = await Promise.all(publicKeyOrKeysArmored.map(key => readKey({ armoredKey: key })));

    } else {
      publicKeyOrKeys = await readKey({ armoredKey: publicKeyOrKeysArmored as string });
    }
    const encrypted = await encrypt({
      message: await createMessage({ text: dataToEncrypt }),
      encryptionKeys: publicKeyOrKeys
    });

    return encrypted as string;
  }

  return (
    <div className="submit-review-wrapper">
      {t("SubmitVulnerability.Submit.review-notice")}

      <div className="review-details-container">
        <div className="project-and-contact-container">
          <div className="review-item project-name-item">
            <div className="item-title-container">
              <span>{t("SubmitVulnerability.Submit.project-name")}</span>
              <img src={EditIcon} alt="edit" onClick={() => toggleCard(Card.project)} />
            </div>
            <span className="item-value">{cards.project.projectName}</span>
          </div>
          <div className="review-item">
            <div className="item-title-container">
              <span>{t("SubmitVulnerability.Submit.contact-info")}</span>
              <img src={EditIcon} alt="edit" onClick={() => toggleCard(Card.contact)} />
            </div>
            <span className="item-value">{cards.contact.username}</span>
          </div>
        </div>

        <div className="description-container">
          <div className="review-item">
            <div className="item-title-container">
              <span>{t("SubmitVulnerability.Submit.vulnerability-description")}</span>
              <img src={EditIcon} alt="edit" onClick={() => toggleCard(Card.description)} />
            </div>
            <span className="item-value">{cards.description.description}</span>
          </div>
        </div>
      </div>

      <button disabled={!isVerified || submittingVulnerability || !account || (vault && !committeeCheckedIn) || !isSupportedNetwork} onClick={handleSubmit}>{t("SubmitVulnerability.Submit.submit")}</button>
      {vault && !committeeCheckedIn && <span className="error-label">{t("SubmitVulnerability.Submit.committee-not-checked")}</span>}
      {showSubmitWarning && <span className="error-label">{`Please make sure you completed all steps and your wallet is connected.`}</span>}
      {(submittingVulnerability) && <Loading fixed extraText="Submitting might take longer than usual" domElement={document.getElementById("accrodionWrapper") as HTMLElement} zIndex={0} />}
    </div>
  )
}