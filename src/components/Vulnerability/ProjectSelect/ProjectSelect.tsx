import { useContext, useState } from "react";
import { useSelector } from "react-redux";
import { RootState } from "../../../reducers";
import SearchIcon from "../../../assets/icons/search.icon";
import { IVault } from "../../../types/types";
import Loading from "../../Shared/Loading";
import { AccordionContext } from "../VulnerabilityAccordion";
import { ScreenSize } from "../../../constants/constants";
import { Card, IProjectData } from "../types";
import { useVaults } from "hooks/useVaults";
import Project from "./components/Project/Project";
import "./index.scss";
import { useTranslation } from "react-i18next";

interface IProps {
  data: IProjectData
}

export default function ProjectSelect({ data }: IProps) {
  const { t } = useTranslation();
  const [userInput, setUserInput] = useState("");
  const { vaults: vaultsData } = useVaults();
  const { submitCard } = useContext(AccordionContext);
  const screenSize = useSelector((state: RootState) => state.layoutReducer.screenSize);

  const vaults = vaultsData?.map((vault: IVault, index: number) => {
    const projectName = vault.description?.["project-metadata"].name;
    if (projectName?.toLowerCase().includes(userInput.toLowerCase()) && !vault.liquidityPool && vault.registered) {
      return (
        <Project
          key={index}
          vault={vault}
          projectId={data.projectId}
          submit={() => submitCard(Card.project, Card.contact, {
            projectName: vault.description?.["project-metadata"].name,
            projectId: vault.id,
            contractAddress: vault.master.address,
          })} />
      )
    }
    return undefined;
  })

  return <div className="project-select-wrapper">
    {!vaults ? <Loading /> :
      <>
        <div className="search-wrapper">
          <SearchIcon />
          <input type="text" placeholder="Search or select project" onChange={(e) => setUserInput(e.target.value)} />
        </div>

        {vaults.every((value: any) => value === undefined) ?
          <div className="no-results">{t("ProjectSelect.no-projects")}</div> :
          <div className="table-wrapper">
            <table>
              <tbody>
                {screenSize === ScreenSize.Desktop && (
                  <tr>
                    <th>{t("ProjectSelect.project-name")}</th>
                    <th>{t("ProjectSelect.vault-total")}</th>
                  </tr>
                )}
                {vaults}
              </tbody>
            </table>
          </div>}
      </>}
  </div>
}
